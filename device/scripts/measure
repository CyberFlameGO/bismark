#!/bin/sh
# Executes a measurement cycle
# 
# author: walter.dedonato@unina.it

# Load configuration file
. ~/conf/dev.conf

# Globals
xml_file="/tmp/${DEVID}_$(date +%s).xml"

# Get target IP
# $1 = tool
# $2 = target category
target()
{
	dst=$(awk '
		/\[.*\]/{ if (s == 1) { s=0 } }
		/\['$2'\]/{ s=1 }
		(s == 1) && /^[a-z0-9]/ && /'$1'/{ print $1 }
	' ~/conf/targets.conf | head -1)
}

# Create dirs and files
mkdir -p /tmp/measure
[ -e /tmp/measure/counter ] || echo 0 > /tmp/measure/counter

# Get and update count
count=$(cat /tmp/measure/counter)
echo $((count + 1)) > /tmp/measure/counter

# XML file header
cat > $xml_file <<-end
	<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
	<measurements version="1.0">
	        <info deviceid=$DEVID userid=$USERID />
end

# RTT measurement using PING
src=$(cat /tmp/ip)
target PING Bismark
bping $dst | mstats RTT PING $src $dst >> $xml_file

# Traceroute
if [ $((count % 6)) -eq 0 ]; then
	target TR Bismark
	hops=$(btr $dst)
	cat >> $xml_file <<-end
	        <traceroute srcip=$src dstip=$dst timestamp=$(date +%s) hops=$(echo "$hops" | wc -l)>
		$(echo "$hops" | awk '{ print "                " $0 }')
	        </traceroute>
	end
fi

# Downstream bitrate using wget
if [ $((count % 4)) -eq 0 ]; then
	target FTPDL Bismark
	bwget $dst dw | mstats BITRATE WGET $dst $src >> $xml_file
fi

# XML file footer
cat >> $xml_file <<-end
	</measurements>
end

# Move file to measure folder
mv $xml_file /tmp/measure
