#!/bin/sh
# Device actions script
# Provides:
# - on-demand SSH tunnel
# - server heartbeat
# - software update
# - information query
#
# author: walter.dedonato@unina.it

# Import configuration and functions
. ~/conf/dev.conf
. ~/bin/functions

# Help screen
[ $1 ] || { echo "$(basename $0) <command> [options]" ; exit ; }

# OS depending options
case $DEVID in
LS*)
	NC_OPTS="-nuc"
	KEEP_ALIVE="-K 120"
	WIF="wl0"
	alias filter="awk -F- '/^-[a-zA-Z]/{ print \$2 }'"
;;
NB*)
	NC_OPTS="-q1 -nu"
	KEEP_ALIVE="-o ServerAliveInterval=60 -o ServerAliveCountMax=30"
	WIF="ath0"
	alias filter="awk -F\< '/^</{ print \$2 }'"
	NB=true
;;
esac

# Perform action
case $1 in
fwd)
	# on-demand SSH tunnel
	ssh $KEEP_ALIVE -N -i $SSH_KEY -R $2:127.0.0.1:22 $USER@$SERVER &
;;
pong)
	# Server heartbeat
	date +%s > /tmp/server_last
	echo $2 > /tmp/ip
;;
update)
	# Software update
	case $2 in
	all)
		# Get new package
		scp -q -i $SSH_KEY $USER@$SERVER:~/bismark/device/dev-*.tgz /tmp/dev.tgz
		# Remove old files
		(cd /root ; find * -path "*/*" | sort) > /tmp/old
		tar -tzf /tmp/dev.tgz | sort > /tmp/new
		rm -f $(diff /tmp/old /tmp/new | filter)
		rm /tmp/old /tmp/new
		# Extract new package
		tar -C /root -xzf /tmp/dev.tgz
		rm /tmp/dev.tgz
		# Apply changes
		crontab conf/crontab
		[ $NB ] && /noxbox/bin/persist_changes
	;;
	*)
		scp -i $SSH_KEY $USER@$SERVER:~/bismark/device/$2 /root/$2
		[ $NB ] && /noxbox/bin/persist_files /root/$2	
	;;
	esac
	find /root | nc $NC_OPTS $SERVER $REPLY_PORT
;;
info)
	# Info reply
	nc $NC_OPTS $SERVER $REPLY_PORT <<-end
		Version: $(cat ~/VERSION)
		User ID: $(cat ~/USER)
		Channel: $(iwlist $WIF channel | awk -F: '/Current/{ print $2 }')
		ESSID: $(iwconfig $WIF | awk -F\" '/ESSID/{ print $2 }')
	end
;;
config)
	# Push configuration
	IFS=$'&'
	for param in $2; do
		option=${param%=*}
        	value=${param#*=}
		case $option in
		channel) 
			case $DEVID in
			LS*) echo LS ;;
			NB*) 
				mod_conf /etc/hostapd/hostapd.conf channel $value
				iwconfig $WIF channel $value
			;;
			esac
		;;
		ssid)
			case $DEVID in
			LS*) echo LS ;;
			NB*) 
				mod_conf /etc/hostapd/hostapd.conf ssid $value
				iwconfig $WIF essid $value
			;;
			esac
		;;
		passphrase)
			case $DEVID in
			LS*) echo LS ;;
			NB*) 
				echo "00:00:00:00:00:00\"$value" > /etc/hostapd/wpa_psk
				/etc/init.d/hostapd restart
			;;
			esac
		;;
		esac
	done
;;
esac

