#!/bin/bash
# Device startup script
#
# author walter.dedonato@unina.it

# Load configuration
. ~/conf/dev.conf

case $DEVICE_ID in
NB*)
	# Configure wireless interface channel
	grep -q ^channel= /etc/hostapd/hostapd.conf || echo channel=1 >> /etc/hostapd/hostapd.conf
	iwconfig ath0 channel $(awk -F= '/^channel/{ print $2 }' /etc/hostapd/hostapd.conf)

	# Setup dhcp log script
	if ! grep -q ^dhcp-script= /etc/dnsmasq.conf ; then
		echo "dhcp-script=/root/scripts/bdhcp" >> /etc/dnsmasq.conf
		/etc/init.d/dnsmasq restart
	fi

	# Set local time
	ln -fs /usr/share/zoneinfo/$LOCALTIME /etc/localtime

	# Set boot event
	bevent boot
	
	# Set reboot script
	echo -e "#!/bin/bash\n/root/scripts/bevent reboot" > /etc/init.d/breboot
	chmod +x /etc/init.d/breboot
	ln -s /etc/init.d/breboot /etc/rc6.d/S10_breboot

	# Start modem monitor
	bevent modem
;;
LS*)
	# Create bin and lib directories on ramdisk
	mkdir -p /tmp/bin /tmp/lib
	ln -fs /tmp/bin bin
	ln -fs /tmp/lib lib
	sleep 10
	[ -d /tmp/measure ] || action update
;;
esac
